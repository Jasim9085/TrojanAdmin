<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #6c757d;
            --success-color: #4bb543;
            --error-color: #ff3333;
            --warning-color: #ff9500;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h2 {
            margin: 0;
            font-weight: 600;
        }

        .content {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        select, input, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 16px;
            transition: var(--transition);
            background-color: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .status-log {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            text-align: left;
            font-weight: 500;
        }

        .log-info {
            background-color: #e7f1ff;
            color: #004085;
            border-left: 4px solid var(--primary-color);
        }

        .log-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .log-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--error-color);
        }

        .data-panel {
            margin-top: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .data-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .data-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .data-value {
            color: var(--text-color);
            font-weight: 500;
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background-color: #f1f1f1;
        }

        #visualizer {
            width: 100%;
            height: 350px;
            background-color: #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .position-analysis {
            background: #e7f1ff;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            border: 1px solid #b8d0ff;
        }

        .position-analysis h4 {
            font-size: 16px;
            color: var(--primary-dark);
            margin: 0;
        }
        
        #app-list-container {
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 15px;
        }

        .app-list-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .app-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
            align-items: center;
        }

        .app-name {
            font-weight: 500;
            flex: 2;
        }

        .app-package {
            font-size: 12px;
            color: var(--text-light);
            flex: 3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-box {
            margin-bottom: 15px;
        }

        #password-view {
            padding: 30px;
            text-align: center;
        }

        #password-view h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        #password-view input {
            margin-bottom: 15px;
        }

        #admin-panel-view {
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div id="password-view">
            <h2>Enter Admin Password</h2>
            <input type="password" id="ui-password-input" placeholder="Enter UI Password" onkeyup="if(event.key === 'Enter') checkUiPassword();">
            <button onclick="checkUiPassword()">Unlock Dashboard</button>
        </div>

        <div id="admin-panel-view">
            <div class="header">
                <h2>Device Management Dashboard</h2>
            </div>

            <div class="content">
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('control-tab')">Control</div>
                    <div class="tab" onclick="switchTab('data-tab')">Device Data</div>
                </div>

                <div id="control-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="device-dropdown">Select Device</label>
                        <select id="device-dropdown" onchange="startPolling()">
                            <option value="">-- Loading Devices --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="action-dropdown">Select Command</label>
                        <select id="action-dropdown">
                            <option value="">-- Loading Commands --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="backend-password">API Password</label>
                        <input type="password" id="backend-password" placeholder="Enter Backend API Password">
                    </div>

                    <button id="send-button" onclick="sendCommand()">Send Command</button>

                    <div id="status-log" class="status-log log-info">
                        Awaiting command...
                    </div>
                </div>

                <div id="data-tab" class="tab-content">
                    <div class="data-panel">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Screen Status</div><div class="data-value" id="data-screen">--</div></div>
                            <div class="data-item"><div class="data-label">Battery Level</div><div class="data-value" id="data-battery">--</div></div>
                            <div class="data-item"><div class="data-label">Location</div><div class="data-value" id="data-location">--</div></div>
                            <div class="data-item"><div class="data-label">Current App</div><div class="data-value" id="data-current-app">--</div></div>
                            <div class="data-item"><div class="data-label">Proximity</div><div class="data-value" id="data-proximity">--</div></div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="refresh-btn" onclick="forceRefresh()"><span id="refresh-text">Refresh Data</span><span id="refresh-spinner" class="loading-spinner" style="display: none;"></span></button>
                        <button id="visualize-btn" onclick="showModal('visualizer-modal')" disabled>Visualize Orientation</button>
                        <button id="apps-btn" onclick="showAppList()">View Installed Apps</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="app-list-modal" class="modal" onclick="hideModal('app-list-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3>Installed Applications</h3><button class="close-btn" onclick="hideModal('app-list-modal')">&times;</button></div><div class="search-box"><input type="text" id="app-search" placeholder="Search applications..." onkeyup="filterApps()"></div><div class="app-list-header"><div class="app-name">Application Name</div><div class="app-package">Package Name</div></div><div id="app-list-container"></div></div></div>
    <div id="visualizer-modal" class="modal" onclick="hideModal('visualizer-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Contextual Device Visualization</h3>
                <button class="close-btn" onclick="hideModal('visualizer-modal')">&times;</button>
            </div>
            
            <div id="visualizer"></div>
            
            <div class="position-analysis">
                <h4>Position Analysis: <span id="position-status">--</span></h4>
            </div>
            
            <p style="text-align:center; font-size:12px; margin-top:15px; color:var(--text-light);">Click and drag to rotate view. Scroll to zoom.</p>
        </div>
    </div>

    <script>
        // Configuration
        const UI_UNLOCK_PASSWORD = "password";
        const COMMANDS_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/commands.json";
        const DEVICES_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/devices.json";
        
        let dataPollInterval, installedApps = {}, isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';
        let scene, camera, renderer, controls, phoneModel, pocketModel;
        let animationFrameId;

        // --- VISUALIZATION LOGIC ---
        function initVisualizer() {
            const container = document.getElementById('visualizer');
            if (!container) return;
            container.innerHTML = '';
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe9ecef);
            
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 3, 7);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.5, 0);

            createEnvironment();
            createPhoneModel();
            
            startAnimationLoop();
            window.addEventListener('resize', onWindowResize);
        }

        function createEnvironment() {
            const tableGeometry = new THREE.BoxGeometry(4, 0.15, 2.5);
            const tableMaterial = new THREE.MeshStandardMaterial({ color: 0xadb5bd });
            const table = new THREE.Mesh(tableGeometry, tableMaterial);
            table.position.y = 0.5;
            table.receiveShadow = true;
            scene.add(table);
            
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xf8f9fa, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // **UPGRADE: Create a pocket model, initially hidden**
            const pocketGeometry = new THREE.BoxGeometry(1, 1.8, 0.5);
            const pocketMaterial = new THREE.MeshStandardMaterial({
                color: 0x6c757d,
                transparent: true,
                opacity: 0.3,
                roughness: 0.7
            });
            pocketModel = new THREE.Mesh(pocketGeometry, pocketMaterial);
            pocketModel.visible = false; // Hide it by default
            scene.add(pocketModel);
        }

        function createPhoneModel() {
            phoneModel = new THREE.Group();
            const bodyGeometry = new THREE.BoxGeometry(0.8, 1.6, 0.1); // width, height, depth
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, metalness: 0.7, roughness: 0.3 });
            const phoneBody = new THREE.Mesh(bodyGeometry, bodyMaterial);
            phoneBody.castShadow = true;
            
            const screenCanvas = document.createElement('canvas');
            screenCanvas.width = 128;
            screenCanvas.height = 256;
            const context = screenCanvas.getContext('2d');
            context.fillStyle = '#222';
            context.fillRect(0, 0, 128, 256);
            context.fillStyle = '#FFF';
            context.fillRect(24, 240, 80, 8);
            const screenTexture = new THREE.CanvasTexture(screenCanvas);

            const screenGeometry = new THREE.BoxGeometry(0.75, 1.55, 0.02);
            const screenMaterial = new THREE.MeshStandardMaterial({ map: screenTexture, roughness: 0.1, metalness: 0.2 });
            const phoneScreen = new THREE.Mesh(screenGeometry, screenMaterial);
            phoneScreen.position.z = 0.055;
            
            phoneModel.add(phoneBody, phoneScreen);
            scene.add(phoneModel);
        }

        // **UPGRADE: Advanced position analysis using accelerometer and proximity**
        function analyzeAndSetPosition(accel, proximity) {
            if (!phoneModel || !accel) return;

            const positionStatusEl = document.getElementById('position-status');
            const { x, y, z } = accel;
            const totalAccel = Math.sqrt(x*x + y*y + z*z);
            let positionText = "Undetermined";

            // Make the pocket invisible by default on each analysis
            pocketModel.visible = false;

            // PRIORITY 1: Device is being held for a call (proximity active, mostly vertical)
            if (proximity < 2 && Math.abs(y) / totalAccel > 0.7) {
                positionText = "Calling Position";
                phoneModel.position.set(0, 1.5, 0.3); // Lifted and close
                phoneModel.rotation.set(-0.3, 0, 0.1); // Tilted back and slightly sideways
            }
            // PRIORITY 2: Device is in pocket (proximity active, mostly upside down)
            else if (proximity < 2 && y < -5) {
                positionText = "In Pocket";
                pocketModel.visible = true; // Show the pocket visualization
                pocketModel.position.set(0, 1, 0);
                phoneModel.position.copy(pocketModel.position);
                phoneModel.rotation.set(Math.PI - 0.1, 0, 0); // Upside down
            }
            // PRIORITY 3: Device is lying on a flat surface
            else if (Math.abs(z) / totalAccel > 0.9) {
                phoneModel.position.set(0, 0.5 + 0.051, 0); // On table surface
                if (z > 0) {
                    positionText = "On a Surface (Face Up)";
                    phoneModel.rotation.set(-Math.PI / 2, 0, 0);
                } else {
                    positionText = "On a Surface (Face Down)";
                    phoneModel.rotation.set(Math.PI / 2, 0, 0);
                }
            }
            // PRIORITY 4: Device is being held for viewing
            else {
                positionText = "In Hand (Viewing)";
                phoneModel.position.set(0, 1.4, 0); // Centered and lifted
                phoneModel.rotation.set(-0.2, 0, 0); // Slight backward tilt for viewing
            }
            
            if(positionStatusEl) positionStatusEl.textContent = positionText;
        }

        function startAnimationLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            const animate = () => {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            };
            animate();
        }

        function stopAnimationLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            window.removeEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            const container = document.getElementById('visualizer');
            if (!container || !camera || !renderer) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // --- Core Dashboard Functions (Unchanged) ---
        function switchTab(tabId){document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")}),document.querySelectorAll(".tab").forEach(t=>{t.classList.remove("active")}),document.getElementById(tabId).classList.add("active"),document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add("active")}
        function checkUiPassword(){const t=document.getElementById("ui-password-input");t.value===UI_UNLOCK_PASSWORD?(sessionStorage.setItem("isAuthenticated","true"),isAuthenticated=!0,showAdminPanel()):(alert("Incorrect password! Please try again."),t.value="",t.focus())}
        function showAdminPanel(){document.getElementById("password-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",document.getElementById("device-dropdown").options.length<=1&&(populateDropdown("device-dropdown",DEVICES_JSON_URL,"Device"),populateDropdown("action-dropdown",COMMANDS_JSON_URL,"Command"))}
        async function populateDropdown(id,url,type){const e=document.getElementById(id);try{const t=await fetch(url);if(!t.ok)throw new Error(`Failed to fetch ${type}s`);const n=await t.json();e.innerHTML="",e.add(new Option(`-- Select a ${type} --`,"")),n.forEach(t=>{e.add(new Option(t.name||t.value,t.id||t.value,!1,t.disabled))})}catch(t){console.error(`Error loading ${type}s:`,t),e.innerHTML=`<option value="">-- Error Loading ${type}s --</option>`}}
        function showModal(id){document.getElementById(id).style.display="flex",id==="visualizer-modal"&&!animationFrameId&&(typeof THREE!="undefined"&&typeof THREE.OrbitControls!="undefined"?initVisualizer():document.getElementById("visualizer").innerHTML='<p style="color: red; text-align: center; padding-top: 50px;">Error: 3D visualization library failed to load.</p>')}
        function hideModal(id){id==="visualizer-modal"&&stopAnimationLoop(),document.getElementById(id).style.display="none"}
        function startPolling(){const t=document.getElementById("device-dropdown").value;dataPollInterval&&clearInterval(dataPollInterval),t&&(forceRefresh(),dataPollInterval=setInterval(async()=>{await fetchLatestData()},5e3))}
        async function forceRefresh(){const t=document.getElementById("refresh-btn"),e=document.getElementById("refresh-text"),n=document.getElementById("refresh-spinner");t.disabled=!0,e.textContent="Refreshing...",n.style.display="inline-block",await fetchLatestData(),t.disabled=!1,e.textContent="Refresh Data",n.style.display="none"}
        
        async function fetchLatestData(){
            const deviceId = document.getElementById("device-dropdown").value;
            if(!deviceId) return;
            try {
                const res = await fetch(`/.netlify/functions/get-status?deviceId=${deviceId}`);
                if(!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();
                parseAndDisplayData(data);
            } catch(e) {
                console.error("Data fetch failed:", e);
                updateStatusLog("Failed to fetch device data: " + e.message, "error");
            }
        }
        
        function parseAndDisplayData(data) {
            let accel = {}, proximity;
            for (const dataType in data) {
                const payload = data[dataType]?.payload;
                if (!payload) continue;
                try {
                    switch(dataType) {
                        case "screen_status": safeUpdateElement("data-screen", payload || "N/A"); break;
                        case "battery_status":
                            if (payload?.percentage !== undefined) {
                                const batteryText = `${payload.percentage.toFixed(0)}%`;
                                const chargingStatus = payload.isCharging ? " (Charging)" : "";
                                safeUpdateElement("data-battery", batteryText + chargingStatus);
                            }
                            break;
                        case "location":
                            payload?.latitude ? safeUpdateElement("data-location", `${payload.latitude.toFixed(4)}, ${payload.longitude.toFixed(4)}`) : safeUpdateElement("data-location", payload || "N/A");
                            break;
                        case "current_app": safeUpdateElement("data-current-app", payload || "N/A"); break;
                        case "proximity":
                            if (payload?.distance !== undefined) {
                                proximity = payload.distance;
                                safeUpdateElement("data-proximity", `${payload.distance} cm`);
                            }
                            break;
                        case "accelerometer":
                            if (payload?.x !== undefined) {
                                accel = payload;
                                const vizBtn = document.getElementById("visualize-btn");
                                if (vizBtn) vizBtn.disabled = false;
                            }
                            break;
                    }
                } catch(t) {
                    console.error(`Error processing ${dataType}:`, t);
                }
            }
            if (animationFrameId && accel.x !== undefined && proximity !== undefined) {
                analyzeAndSetPosition(accel, proximity);
            }
        }
        
        function safeUpdateElement(id,value){const e=document.getElementById(id);e&&(e.textContent=value)}
        async function sendCommand(){const t=document.getElementById("device-dropdown").value,e=document.getElementById("action-dropdown").value,n=document.getElementById("backend-password").value,o=document.getElementById("send-button");if(!t||!e||!n)return void updateStatusLog("Error: All fields are required.","error");o.disabled=!0,o.innerHTML='<span class="loading-spinner"></span> Sending...';try{const a=await fetch("/.netlify/functions/send-command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:t,action:e,password:n})}),d=await a.json();a.ok?(updateStatusLog(`✅ Success: ${d.message}`,"success"),(e.startsWith("get_")||"list_apps"===e)&&setTimeout(()=>forceRefresh(),1500)):updateStatusLog(`❌ Error: ${d.error||"Unknown server error"}`,"error")}catch(t){updateStatusLog("❌ Network Error: Could not reach the command function.","error")}finally{o.disabled=!1,o.textContent="Send Command"}}
        function updateStatusLog(t,e="info"){const n=document.getElementById("status-log");n.textContent=t,n.className=`status-log log-${e}`}
        function showAppList(){const t=document.getElementById("device-dropdown").value;if(!t)return void updateStatusLog("Please select a device first","error");if(Object.keys(installedApps).length>0)return renderAppList(),void showModal("app-list-modal");fetchAppList()}
        async function fetchAppList(){const t=document.getElementById("device-dropdown").value;if(!t)return;try{const e=await fetch(`/.netlify/functions/get-status?deviceId=${t}&type=installed_apps`);if(!e.ok)throw new Error(`Server responded with status: ${e.status}`);const n=await e.json();if(n.installed_apps&&n.installed_apps.payload)installedApps=n.installed_apps.payload,renderAppList(),showModal("app-list-modal");else throw new Error("Invalid app list data received")}catch(t){console.error("Could not fetch app list:",t),updateStatusLog("Failed to fetch app list: "+t.message,"error")}}
        function renderAppList(){const t=document.getElementById("app-list-container");if(!t)return;t.innerHTML="";const e=Object.entries(installedApps).map(([t,e])=>({pkg:t,name:e}));e.sort((t,e)=>t.name.localeCompare(e.name)),e.forEach(e=>{const n=document.createElement("div");n.className="app-item";const o=document.createElement("div");o.className="app-name",o.textContent=e.name;const a=document.createElement("div");a.className="app-package",a.textContent=e.pkg,n.appendChild(o),n.appendChild(a),t.appendChild(n)});const n=document.createElement("div");n.style.padding="10px",n.style.fontSize="14px",n.style.color="var(--text-light)",n.textContent=`Showing ${e.length} applications`,t.appendChild(n)}
        function filterApps(){const t=document.getElementById("app-search").value.toLowerCase();document.querySelectorAll(".app-item").forEach(e=>{const n=e.querySelector(".app-name").textContent.toLowerCase(),o=e.querySelector(".app-package").textContent.toLowerCase();e.style.display=n.includes(t)||o.includes(t)?"flex":"none"})}
        window.onload=()=>{isAuthenticated&&showAdminPanel(),document.addEventListener("keydown",t=>{"Escape"===t.key&&(hideModal("visualizer-modal"),hideModal("app-list-modal"))})};
    </script>
</body>
</html>
