<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #6c757d;
            --success-color: #4bb543;
            --error-color: #ff3333;
            --warning-color: #ff9500;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h2 { margin: 0; font-weight: 600; }
        .content { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); }
        select, input, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 16px;
            transition: var(--transition);
            background-color: white;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background-color: var(--primary-dark); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .button-group { display: flex; gap: 12px; margin-top: 20px; }
        .button-group button { flex: 1; }
        .status-log {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            text-align: left;
            font-weight: 500;
        }
        .log-info { background-color: #e7f1ff; color: #004085; border-left: 4px solid var(--primary-color); }
        .log-success { background-color: #d4edda; color: #155724; border-left: 4px solid var(--success-color); }
        .log-error { background-color: #f8d7da; color: #721c24; border-left: 4px solid var(--error-color); }
        .data-panel { margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); border: 1px solid #e9ecef; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .data-item { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .data-label { font-weight: 600; color: var(--text-light); font-size: 14px; margin-bottom: 5px; }
        .data-value { color: var(--text-color); font-weight: 500; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-btn:hover { background-color: #f1f1f1; }
        #visualizer { width: 100%; height: 350px; background-color: #e9ecef; border-radius: 8px; margin: 10px 0; position: relative; overflow: hidden; }
        .position-analysis { background: #e7f1ff; border-radius: var(--border-radius); padding: 15px; margin-top: 15px; text-align: center; border: 1px solid #b8d0ff; }
        .position-analysis h4 { font-size: 16px; color: var(--primary-dark); margin: 0; }
        #app-list-container { max-height: 60vh; overflow-y: auto; margin-top: 15px; }
        .app-list-header { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-weight: 600; position: sticky; top: 0; background: white; z-index: 1; }
        .app-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; align-items: center; cursor: pointer; }
        .app-item:hover { background-color: #f8f9fa; }
        .app-name { font-weight: 500; flex: 2; }
        .app-package { font-size: 12px; color: var(--text-light); flex: 3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .search-box { margin-bottom: 15px; }
        #password-view { padding: 30px; text-align: center; }
        #password-view h2 { margin-bottom: 20px; color: var(--primary-color); }
        #password-view input { margin-bottom: 15px; }
        #admin-panel-view { display: none; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-container { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: var(--transition); }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .control-group { border: 1px solid #eee; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; }
        .control-group h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .input-with-button { display: flex; gap: 10px; margin-top: 10px; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button { flex-shrink: 0; width: auto; }
        #image-display { max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; }
        .slider-group { display: flex; align-items: center; gap: 15px; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .slider-group span { font-weight: 500; min-width: 30px; text-align: center; }
    </style>
</head>
<body>
    
    <div class="container">
        <div id="password-view">
            <h2>Enter Admin Password</h2>
            <input type="password" id="ui-password-input" placeholder="Enter UI Password" onkeyup="if(event.key === 'Enter') checkUiPassword();">
            <button onclick="checkUiPassword()">Unlock Dashboard</button>
        </div>

        <div id="admin-panel-view">
            <div class="header">
                <h2>Device Management Dashboard</h2>
            </div>

            <div class="content">
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('control-tab')">Control</div>
                    <div class="tab" onclick="switchTab('data-tab')">Device Data</div>
                    <div class="tab" onclick="switchTab('media-tab')">Media</div>
                    <div class="tab" onclick="switchTab('apps-tab')">Apps</div>
                    <div class="tab" onclick="switchTab('camera-tab')">Camera</div>
                </div>

                <div id="control-tab" class="tab-content active">
                     <div class="control-group">
                        <h3>Main Controls</h3>
                        <div class="form-group">
                            <label for="device-dropdown">Select Device</label>
                            <select id="device-dropdown" onchange="onDeviceSelected()">
                                <option value="">-- Loading Devices --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="action-dropdown">Select Command</label>
                            <select id="action-dropdown">
                                <option value="">-- Loading Commands --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="backend-password">API Password</label>
                            <input type="password" id="backend-password" placeholder="Enter Backend API Password">
                        </div>
                        <button id="send-button" onclick="sendCommandFromDropdown()">Send Command</button>
                    </div>
                    <div id="status-log" class="status-log log-info">Awaiting command...</div>
                </div>

                <div id="data-tab" class="tab-content">
                    <div class="data-panel">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Screen Status</div><div class="data-value" id="data-screen">--</div></div>
                            <div class="data-item"><div class="data-label">Battery Level</div><div class="data-value" id="data-battery">--</div></div>
                            <div class="data-item"><div class="data-label">Charging Status</div><div class="data-value" id="data-charging">--</div></div>
                            <div class="data-item"><div class="data-label">Location</div><div class="data-value" id="data-location">--</div></div>
                            <div class="data-item"><div class="data-label">Current App</div><div class="data-value" id="data-current-app">--</div></div>
                            <div class="data-item"><div class="data-label">Proximity</div><div class="data-value" id="data-proximity">--</div></div>
                            <div class="data-item"><div class="data-label">Light Level</div><div class="data-value" id="data-light">--</div></div>
                            <div class="data-item"><div class="data-label">Last Recording</div><div class="data-value" id="data-recording">--</div><div id="data-recording-player"></div></div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="refresh-btn" onclick="forceRefresh()"><span id="refresh-text">Refresh Data</span><span id="refresh-spinner" class="loading-spinner" style="display: none;"></span></button>
                        <button id="visualize-btn" onclick="showModal('visualizer-modal')" disabled>Visualize Orientation</button>
                        <button id="apps-btn" onclick="showAppListModal()">View Installed Apps</button>
                    </div>
                </div>

                <div id="media-tab" class="tab-content">
                    <div class="control-group">
                        <h3>Audio Control</h3>
                         <div class="button-group">
                           <button onclick="sendCommandWithValue('start_rec')">Start Recording</button>
                           <button onclick="sendCommandWithValue('stop_rec')">Stop Recording</button>
                        </div>
                        <br>
                        <div class="input-with-button">
                            <input type="text" id="sound-url-input" placeholder="https://example.com/sound.mp3">
                            <button onclick="playSound()">Play Sound</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>Volume Control</h3>
                        <div class="slider-group">
                            <input type="range" id="volume-slider" min="0" max="100" value="50" oninput="document.getElementById('volume-value').textContent = this.value">
                            <span id="volume-value">50</span>
                        </div>
                         <div class="button-group">
                           <button onclick="setVolume()">Set Volume</button>
                        </div>
                    </div>
                </div>
                
                <div id="apps-tab" class="tab-content">
                    <div class="control-group">
                        <h3>Application Management</h3>
                        <div class="input-with-button">
                             <input type="text" id="app-url-input" placeholder="https://example.com/app.apk">
                            <button onclick="installApp()">Install App</button>
                        </div>
                        <br>
                        <div class="input-with-button">
                            <input type="text" id="app-package-input" placeholder="com.example.app">
                            <button onclick="uninstallApp()">Uninstall App</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>App Visibility</h3>
                         <div class="button-group">
                           <button onclick="sendCommandWithValue('hide_icon')">Hide App Icon</button>
                           <button onclick="sendCommandWithValue('show_icon')">Show App Icon</button>
                        </div>
                    </div>
                </div>

                <div id="camera-tab" class="tab-content">
                     <div class="control-group">
                        <h3>Screen & Camera</h3>
                        <div class="button-group">
                           <button onclick="sendCommandWithValue('take_screenshot')">Request Screenshot</button>
                           <button onclick="takePicture(0)">Take Pic (Cam 1)</button>
                           <button onclick="takePicture(1)">Take Pic (Cam 2)</button>
                        </div>
                    </div>
                     <div class="control-group">
                        <h3>Show Image on Screen</h3>
                        <div class="input-with-button">
                             <input type="text" id="image-url-input" placeholder="https://example.com/image.jpg">
                            <button onclick="showImage()">Show Image</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="app-list-modal" class="modal" onclick="hideModal('app-list-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3>Installed Applications</h3><button class="close-btn" onclick="hideModal('app-list-modal')">&times;</button></div><div class="search-box"><input type="text" id="app-search" placeholder="Search applications..." onkeyup="filterApps()"></div><div class="app-list-header"><div class="app-name">Application Name</div><div class="app-package">Package Name</div></div><div id="app-list-container"></div></div></div>
    <div id="visualizer-modal" class="modal" onclick="hideModal('visualizer-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3>Contextual Device Visualization</h3><button class="close-btn" onclick="hideModal('visualizer-modal')">&times;</button></div><div id="visualizer"></div><div class="position-analysis"><h4>Position Analysis: <span id="position-status">--</span></h4></div><p style="text-align:center; font-size:12px; margin-top:15px; color:var(--text-light);">Click and drag to rotate view. Scroll to zoom.</p></div></div>
    <div id="image-modal" class="modal" onclick="hideModal('image-modal')"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3 id="image-modal-title">Image</h3><button class="close-btn" onclick="hideModal('image-modal')">&times;</button></div><img id="image-display" src="" alt="Device Capture"></div></div>

    <script>
        const UI_UNLOCK_PASSWORD="password",COMMANDS_JSON_URL="https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/commands.json",DEVICES_JSON_URL="https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/devices.json";let installedApps={},isAuthenticated="true"===sessionStorage.getItem("isAuthenticated"),scene,camera,renderer,controls,phoneModel,pocketModel,animationFrameId;function initVisualizer(){const e=document.getElementById("visualizer");e&&(e.innerHTML="",scene=new THREE.Scene,scene.background=new THREE.Color(15329769),camera=new THREE.PerspectiveCamera(50,e.clientWidth/e.clientHeight,.1,100),camera.position.set(0,1.6,6),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(e.clientWidth,e.clientHeight),renderer.setPixelRatio(window.devicePixelRatio),renderer.shadowMap.enabled=!0,e.appendChild(renderer.domElement),scene.add(new THREE.AmbientLight(16777215,.6)),(e=>{const t=new THREE.DirectionalLight(16777215,.8);t.position.set(5,10,7),t.castShadow=!0,scene.add(t)})(),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.target.set(0,1.2,0),createEnvironment(),createPhoneModel(),startAnimationLoop(),window.addEventListener("resize",onWindowResize))}function createEnvironment(){const e=new THREE.BoxGeometry(5,.15,3),t=new THREE.MeshStandardMaterial({color:11388093}),o=new THREE.Mesh(e,t);o.position.y=0,o.receiveShadow=!0,scene.add(o);const n=new THREE.PlaneGeometry(20,20),a=new THREE.MeshStandardMaterial({color:16314874,roughness:.8}),i=new THREE.Mesh(n,a);i.rotation.x=-Math.PI/2,i.position.y=-.075,i.receiveShadow=!0,scene.add(i);const d=new THREE.BoxGeometry(1,1.8,.5),s=new THREE.MeshStandardMaterial({color:7104157,transparent:!0,opacity:.3,roughness:.7});pocketModel=new THREE.Mesh(d,s),pocketModel.visible=!1,scene.add(pocketModel)}function createPhoneModel(){phoneModel=new THREE.Group;const e=new THREE.BoxGeometry(.8,1.6,.1),t=new THREE.MeshStandardMaterial({color:1703936,metalness:.7,roughness:.3}),o=new THREE.Mesh(e,t);o.castShadow=!0;const n=document.createElement("canvas");n.width=128,n.height=256;const a=n.getContext("2d");a.fillStyle="#222",a.fillRect(0,0,128,256),a.fillStyle="#FFF",a.fillRect(24,240,80,8);const i=new THREE.CanvasTexture(n),d=new THREE.BoxGeometry(.75,1.55,.02),s=new THREE.MeshStandardMaterial({map:i,roughness:.1,metalness:.2}),c=new THREE.Mesh(d,s);c.position.z=.055,phoneModel.add(o,c),scene.add(phoneModel)}
        
        // UPGRADED: More robust visualization for devices with fewer sensors.
        function analyzeAndSetPosition(data) {
            if (!phoneModel) return;

            let orientationQuat = new THREE.Quaternion();
            let hasGoodOrientation = false;

            const rotVec = data.rotation_vector || data.game_rotation_vector || data.geomagnetic_rotation_vector;
            if (rotVec && rotVec.w !== undefined) {
                orientationQuat.set(rotVec.x, rotVec.y, rotVec.z, rotVec.w);
                hasGoodOrientation = true;
            } else if (data.gravity && data.magnetometer) {
                const G = new THREE.Vector3(data.gravity.x, data.gravity.y, data.gravity.z).normalize();
                const M = new THREE.Vector3(data.magnetometer.x, data.magnetometer.y, data.magnetometer.z).normalize();
                const E = M.clone().cross(G).normalize();
                const N = G.clone().cross(E).normalize();
                const orientationMatrix = new THREE.Matrix4().makeBasis(E, N, G);
                orientationQuat.setFromRotationMatrix(orientationMatrix);
                hasGoodOrientation = true;
            }

            if (hasGoodOrientation) {
                const correction = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1, 0, 0), -Math.PI / 2);
                orientationQuat.multiplyQuaternions(correction, orientationQuat);
                phoneModel.quaternion.slerp(orientationQuat, 0.5);
            } else {
                // Default to a neutral, upright position if no orientation data is available.
                phoneModel.quaternion.slerp(new THREE.Quaternion(), 0.5);
            }

            let positionText = "Undetermined";
            pocketModel.visible = false;

            if (data.context_events?.pocket_mode) {
                positionText = "In Pocket";
                pocketModel.visible = true;
                pocketModel.position.set(0, 1.2, 0);
                phoneModel.position.copy(pocketModel.position);
            } else if (data.context_events?.face_up_down !== undefined) {
                positionText = data.context_events.face_up_down === 0 ? "On Surface (Face Up)" : "On Surface (Face Down)";
                phoneModel.position.set(0, 0.075 + 0.05, 0);
            } else if (data.proximity?.distance < 2 && data.light?.lux < 10) {
                 positionText = "In Pocket / Bag";
                 pocketModel.visible = true;
                 pocketModel.position.set(0, 1.2, 0);
                 phoneModel.position.copy(pocketModel.position);
            } else if (data.proximity?.distance < 2) {
                positionText = "Calling Position";
                phoneModel.position.set(0, 1.3, 0);
            } else if (data.gravity) {
                if (Math.abs(data.gravity.z) > 9.0) {
                    positionText = "On a Surface";
                    phoneModel.position.set(0, 0.075 + 0.05, 0);
                } else {
                    positionText = "In Hand";
                    phoneModel.position.set(0, 1.3, 0);
                }
            } else {
                phoneModel.position.set(0, 1.3, 0); // Default to 'in hand' if no other context
            }
            
            // Add a note if orientation data is missing for clarity.
            if (!hasGoodOrientation && positionText !== "Undetermined") {
                positionText += " (Orientation Unavailable)";
            }
            
            document.getElementById('position-status').textContent = positionText;
        }
        
        function startAnimationLoop(){animationFrameId&&cancelAnimationFrame(animationFrameId);const e=()=>{animationFrameId=requestAnimationFrame(e),controls.update(),renderer.render(scene,camera)};e()}function stopAnimationLoop(){animationFrameId&&(cancelAnimationFrame(animationFrameId),animationFrameId=null),window.removeEventListener("resize",onWindowResize)}function onWindowResize(){const e=document.getElementById("visualizer");e&&camera&&renderer&&(camera.aspect=e.clientWidth/e.clientHeight,camera.updateProjectionMatrix(),renderer.setSize(e.clientWidth,e.clientHeight))}function switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active"),document.querySelector(`.tab[onclick="switchTab('${e}')"]`).classList.add("active")}function checkUiPassword(){document.getElementById("ui-password-input").value===UI_UNLOCK_PASSWORD?(sessionStorage.setItem("isAuthenticated","true"),isAuthenticated=!0,showAdminPanel()):alert("Incorrect password! Please try again.")}function showAdminPanel(){document.getElementById("password-view").style.display="none",document.getElementById("admin-panel-view").style.display="block",document.getElementById("device-dropdown").options.length<=1&&(populateDropdown("device-dropdown",DEVICES_JSON_URL,"Device"),populateDropdown("action-dropdown",COMMANDS_JSON_URL,"Command"))}async function populateDropdown(e,t,o){const n=document.getElementById(e);try{const a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch ${o}s`);const i=await a.json();n.innerHTML="",n.add(new Option(`-- Select a ${o} --`,"")),i.forEach(e=>{n.add(new Option(e.name||e.value,e.id||e.value,!1,e.disabled))})}catch(a){console.error(`Error loading ${o}s:`,a),n.innerHTML=`<option value="">-- Error Loading ${o}s --</option>`}}function showModal(e){document.getElementById(e).style.display="flex",e==="visualizer-modal"&&!animationFrameId&&(void 0!==THREE&&void 0!==THREE.OrbitControls?initVisualizer():document.getElementById("visualizer").innerHTML='<p style="color: red; text-align: center; padding-top: 50px;">Error: 3D visualization library failed to load.</p>')}function hideModal(e){"visualizer-modal"===e&&stopAnimationLoop(),document.getElementById(e).style.display="none"}function onDeviceSelected(){["data-screen","data-battery","data-charging","data-location","data-current-app","data-proximity","data-light"].forEach(e=>safeUpdateElement(e,"--")),document.getElementById("visualize-btn").disabled=!0,updateStatusLog("New device selected. Click 'Refresh Data' to fetch its status.","info")}async function forceRefresh(){const e=document.getElementById("refresh-btn"),t=document.getElementById("refresh-text"),o=document.getElementById("refresh-spinner");e.disabled=!0,t.textContent="Refreshing...",o.style.display="inline-block",await fetchLatestData(),e.disabled=!1,t.textContent="Refresh Data",o.style.display="none"}async function fetchLatestData(){const e=document.getElementById("device-dropdown").value;if(!e)return void updateStatusLog("Please select a device first.","error");try{const t=await fetch(`/.netlify/functions/get-status?deviceId=${e}`);if(404===t.status)return void updateStatusLog("No data found for this device yet. Send a command to initialize it.","warning");if(!t.ok)throw new Error(`Server error: ${t.status}`);const o=await t.json();parseAndDisplayData(o),updateStatusLog("Device data refreshed successfully.","success")}catch(t){console.error("Data fetch failed:",t),updateStatusLog("Failed to fetch device data: "+t.message,"error")}}
        // In index.html, inside the <script> tag

function parseAndDisplayData(allData) {
    let hasSensorData = false;
    // onDeviceSelected(); // This was resetting the UI too early. Moved reset logic inside loop.

    for (const key in allData) {
        // --- THIS IS THE CRITICAL FIX ---
        // Check if the key is for a media file.
        const isMediaKey = ["screenshot", "picture", "last_recording"].includes(key);
        
        // If it's a media key, the data itself is the payload.
        // Otherwise, get the payload from inside the object.
        const payload = isMediaKey ? allData[key] : allData[key]?.payload;

        if (!payload) {
            // If there's no payload for this key, skip to the next one.
            continue;
        }
        
        try {
            switch(key) {
                case "screen_status":
                    safeUpdateElement("data-screen", payload || "N/A");
                    break;
                case "battery_status":
                    if (payload?.percentage !== undefined) {
                        safeUpdateElement("data-battery", `${payload.percentage.toFixed(0)}%`);
                        safeUpdateElement("data-charging", payload.isCharging ? "✅ Charging" : "❌ Not Charging");
                    }
                    break;
                case "location":
                    payload?.latitude ? safeUpdateElement("data-location", `${`${payload.latitude.toFixed(4)}, ${payload.longitude.toFixed(4)}`}`) : safeUpdateElement("data-location", payload || "N/A");
                    break;
                case "current_app":
                    safeUpdateElement("data-current-app", payload || "N/A");
                    break;
                case "proximity":
                    if (payload?.distance !== undefined) safeUpdateElement("data-proximity", `${payload.distance} cm`);
                    hasSensorData = true;
                    break;
                case "light":
                    if (payload?.lux !== undefined) safeUpdateElement("data-light", `${payload.lux.toFixed(1)} lux`);
                    hasSensorData = true;
                    break;
                case "screenshot":
                     document.getElementById('image-modal-title').textContent = "Screenshot";
                     // The payload is already the correct Base64 string because of our fix above.
                     document.getElementById('image-display').src = `data:image/jpeg;base64,${payload}`;
                     showModal('image-modal');
                     break;
                case "picture":
                     document.getElementById('image-modal-title').textContent = "Camera Picture";
                     // The payload is already the correct Base64 string.
                     document.getElementById('image-display').src = `data:image/jpeg;base64,${payload}`;
                     showModal('image-modal');
                     break;
                case "last_recording":
                     const playerContainer = document.getElementById('data-recording-player');
                     const recordingValue = document.getElementById('data-recording');
                     playerContainer.innerHTML = ''; // Clear any old player

                     // The payload is already the correct Base64 string.
                     const audio = document.createElement('audio');
                     audio.controls = true;
                     audio.src = `data:audio/mp3;base64,${payload}`;
                     playerContainer.appendChild(audio);
                     recordingValue.textContent = "New recording ready to play.";
                     break;
                default:
                    // This logic is for the orientation visualizer
                    if (["rotation_vector", "gravity", "magnetometer"].includes(key)) hasSensorData = true;
                    break;
            }
        } catch(e) { console.error(`Error processing display data for ${key}:`, e); }
    }

    if(hasSensorData) {
        document.getElementById("visualize-btn").disabled = false;
        const sensorPayload = {};
        for(const key in allData) {
             const isMediaKey = ["screenshot", "picture", "last_recording"].includes(key);
             sensorPayload[key] = isMediaKey ? allData[key] : allData[key]?.payload;
        }
        analyzeAndSetPosition(sensorPayload);
    }
}
        function safeUpdateElement(e,t){const o=document.getElementById(e);o&&(o.textContent=t)}async function sendCommandWithValue(e,t={}){const o=document.getElementById("device-dropdown").value,n=document.getElementById("backend-password").value,a=document.getElementById("send-button");if(!o||!e||!n)return updateStatusLog("Error: Device, Action, and Password are required.","error");const i=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="loading-spinner"></span> Sending...';try{const d=await fetch("/.netlify/functions/send-command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:o,action:e,password:n,...t})}),s=await d.json();d.ok?(updateStatusLog(`✅ Success: ${s.message}`,"success"),(e.startsWith("get_")||e.startsWith("take_")||"list_apps"===e)&&setTimeout(()=>forceRefresh(),2e3)):updateStatusLog(`❌ Error: ${s.error||"Unknown server error"}`,"error")}catch(d){updateStatusLog("❌ Network Error: Could not reach the command function.","error")}finally{a.disabled=!1,a.innerHTML=i}}function sendCommandFromDropdown(){const e=document.getElementById("action-dropdown").value;sendCommandWithValue(e)}function playSound(){const e=document.getElementById("sound-url-input").value;e?sendCommandWithValue("play_sound",{url:e}):updateStatusLog("Please enter a sound URL.","error")}function showImage(){const e=document.getElementById("image-url-input").value;e?sendCommandWithValue("show_image",{url:e}):updateStatusLog("Please enter an image URL.","error")}
        function setVolume() { const e=document.getElementById("volume-slider").value;sendCommandWithValue("set_volume",{level:e}) }
        function installApp() { const e=document.getElementById("app-url-input").value;e?sendCommandWithValue("install_app",{url:e}):updateStatusLog("Please enter an APK URL.","error") }
        function uninstallApp() { const e=document.getElementById("app-package-input").value;e?sendCommandWithValue("uninstall_app",{package_name:e}):updateStatusLog("Please enter a package name.","error") }
        function takePicture(e) { sendCommandWithValue("take_picture",{camera_id:e}) }
        function updateStatusLog(e,t="info"){const o=document.getElementById("status-log");o.textContent=e,o.className=`status-log log-${t}`}function showAppListModal(){const e=document.getElementById("device-dropdown").value;e?Object.keys(installedApps).length>0?(renderAppList(),void showModal("app-list-modal")):fetchAppList():updateStatusLog("Please select a device first","error")}async function fetchAppList(){const e=document.getElementById("device-dropdown").value;if(!e)return;try{const t=await fetch(`/.netlify/functions/get-status?deviceId=${e}&type=installed_apps`);if(!t.ok)throw new Error(`Server responded with status: ${t.status}`);const o=await t.json();o.installed_apps&&o.installed_apps.payload?(installedApps=o.installed_apps.payload,renderAppList(),showModal("app-list-modal")):updateStatusLog("No app list data found for this device.","warning")}catch(t){console.error("Could not fetch app list:",t),updateStatusLog("Failed to fetch app list: "+t.message,"error")}}function renderAppList(){const e=document.getElementById("app-list-container");if(e){e.innerHTML="";const t=Object.entries(installedApps).map(([e,t])=>({pkg:e,name:t}));t.sort((e,t)=>e.name.localeCompare(t.name)),t.forEach(t=>{const o=document.createElement("div");o.className="app-item",o.onclick=()=>sendCommandWithValue("open_app",{package_name:t.pkg});const n=document.createElement("div");n.className="app-name",n.textContent=t.name;const a=document.createElement("div");a.className="app-package",a.textContent=t.pkg,o.appendChild(n),o.appendChild(a),e.appendChild(o)});const o=document.createElement("div");o.style.padding="10px",o.style.fontSize="14px",o.style.color="var(--text-light)",o.textContent=`Showing ${t.length} applications`,e.appendChild(o)}}function filterApps(){const e=document.getElementById("app-search").value.toLowerCase();document.querySelectorAll(".app-item").forEach(t=>{const o=t.querySelector(".app-name").textContent.toLowerCase(),n=t.querySelector(".app-package").textContent.toLowerCase();t.style.display=o.includes(e)||n.includes(e)?"flex":"none"})}window.onload=()=>{isAuthenticated&&showAdminPanel(),document.addEventListener("keydown",e=>{"Escape"===e.key&&(hideModal("visualizer-modal"),hideModal("app-list-modal"),hideModal("image-modal"))})};
    </script>
</body>
</html>
